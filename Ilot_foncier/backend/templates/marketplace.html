{% extends 'base_citizen.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-5">
    <div>
        <h6 class="text-primary fw-bold text-uppercase mb-2" style="letter-spacing: 0.1em;">Place de March√© Digitale
        </h6>
        <h1 class="display-5 fw-bold mb-0">Terrains Disponibles</h1>
    </div>
    <div class="d-none d-md-block">
        <div class="p-3 bg-white rounded-4 border shadow-sm">
            <small class="text-muted d-block">Total des Offres</small>
            <span class="h4 fw-bold text-primary mb-0">{{ listings|length }}</span>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <!-- Vue Carte Simul√©e -->
    <div class="col-lg-8">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <div class="citizen-card p-0 overflow-hidden" style="height: 450px; border: 2px solid #e2e8f0;">
            <div id="map" style="height: 100%; width: 100%; z-index: 1;"></div>
        </div>

        {{ listings_json|json_script:"listings-data" }}

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Init Map (Centr√© sur Cotonou par d√©faut)
                var map = L.map('map').setView([6.3703, 2.3912], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);

                // R√©cup√©ration des donn√©es s√©curis√©es via le script tag
                const listingsData = JSON.parse(document.getElementById('listings-data').textContent);

                const markers = [];
                listingsData.forEach(item => {
                    if (item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng]).addTo(map)
                            .bindPopup(`
                                <div class="text-center">
                                    <h6 class="fw-bold mb-1">${item.village || 'Parcelle'}</h6>
                                    <span class="badge bg-primary mb-2">${item.price_fiat} FCFA</span><br>
                                    <a href="/property/${item.id}/" class="btn btn-sm btn-outline-primary py-1 mt-1">D√©tails techniques</a>
                                </div>
                            `);
                        markers.push(marker);
                    }
                });

                // Auto-fit bounds if markers exist
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            });
        </script>
    </div>
    <!-- Stats Marketplace -->
    <div class="col-lg-4">
        <div class="citizen-card h-100 bg-primary border-0 shadow-lg text-white">
            <h5 class="fw-bold mb-4 text-white">Tendances du March√©</h5>
            <div class="mb-4">
                <small class="text-white text-opacity-75 d-block mb-1">Prix Moyen / m¬≤</small>
                <h3 class="fw-bold text-white">12.500 FCFA</h3>
            </div>
            <div class="mb-4">
                <small class="text-white text-opacity-75 d-block mb-1">Volume de Transactions (24h)</small>
                <h3 class="fw-bold text-white">4.2M FCFA</h3>
            </div>
            <hr class="border-white border-opacity-25">
            <p class="small text-white text-opacity-75">
                Toutes les transactions sur la marketplace iL√¥t sont s√©curis√©es par des contrats s√©questres intelligents
                sur la blockchain Polygon.
            </p>
        </div>
    </div>
</div>

<h4 class="fw-bold mb-4">Annonces R√©centes</h4>
<div class="row g-4">
    {% for listing in listings %}
    <div class="col-md-4">
        <div class="citizen-card h-100 d-flex flex-column hover-up">
            <div class="position-relative mb-4">
                <div class="rounded-4 bg-light overflow-hidden" style="height: 200px;">
                    <!-- Image placeholder ou g√©n√©r√©e -->
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-primary bg-opacity-10">
                        <span class="display-1">üè°</span>
                    </div>
                </div>
                <span class="badge bg-success position-absolute top-0 end-0 m-3 shadow-sm">EN VENTE</span>
                {% if listing.property.is_certified %}
                <span class="badge bg-primary position-absolute top-0 start-0 m-3 shadow-sm">üõ°Ô∏è DOSSIER CERTIFI√â</span>
                {% else %}
                <span class="badge bg-warning text-dark position-absolute top-0 start-0 m-3 shadow-sm">‚ö†Ô∏è EN ATTENTE
                    CERTIF.</span>
                {% endif %}
            </div>

            <h5 class="fw-bold mb-1">{{ listing.property.village|default:"Parcelle iL√¥t" }}</h5>
            <p class="text-muted small mb-4">
                <span class="me-2">üìç</span> {{ listing.property.district }}, {{ listing.property.country }}
            </p>

            <div class="mt-auto">
                <div class="p-3 bg-light rounded-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted d-block">Prix en FCFA</small>
                            <span class="h5 fw-bold mb-0">{{ listing.price_fiat }} FCFA</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Crypto (cUSD)</small>
                            <span class="fw-bold text-primary">{{ listing.price_crypto }}</span>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-citizen"
                        onclick="contactSeller('{{ listing.id }}', '{{ listing.property.is_certified }}')">
                        CONTACTER LE VENDEUR
                    </button>
                    <a href="{% url 'web_property_detail' listing.property.id %}"
                        class="btn btn-outline-secondary rounded-3 btn-sm">D√©tails techniques</a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
        <div class="citizen-card border-dashed">
            <span class="display-1 d-block mb-4">üì≠</span>
            <h4 class="fw-bold">Aucune offre active</h4>
            <p class="text-muted">Revenez plus tard ou mettez votre propre terrain en vente depuis votre dashboard.</p>
        </div>
    </div>
    {% endfor %}
</div>

<style>
    .hover-scale {
        transition: transform 0.3s ease;
    }

    .hover-scale:hover {
        transform: translate(-50%, -50%) scale(1.2);
        z-index: 100;
    }

    .hover-up {
        transition: all 0.3s ease;
    }

    .hover-up:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    function contactSeller(listingId, isCertified) {
        if (isCertified === 'True') {
            alert("‚úÖ Dossier Certifi√© d√©tect√© !\n\nVotre demande a √©t√© envoy√©e au vendeur. Vous recevrez une notification d√®s qu'il acceptera de vous partager les documents officiels (PV de g√©om√®tre, attestations des t√©moins).");
        } else {
            alert("‚ö†Ô∏è Dossier en cours de certification.\n\nVous pouvez contacter le vendeur, mais notez que les documents officiels ne sont pas encore tous valid√©s par les experts iL√¥t.");
        }
    }
</script>
{% endblock %}