{% extends 'base_citizen.html' %}
{% block sidebar %}{% endblock %}
{% block main_class %}col-12{% endblock %}

{% block content %}
<div class="row justify-content-center align-items-center" style="min-height: 70vh;">
    <div class="col-md-5">
        <div class="text-center mb-5">
            <h1 class="display-6 fw-bold mb-2">Nouveau mot de passe</h1>
            <p class="text-muted">Cr√©ez un nouveau mot de passe s√©curis√© pour votre compte.</p>
        </div>

        <div class="citizen-card animate-up">
            <form id="confirmResetForm">
                <div class="mb-4">
                    <label class="form-label fw-bold text-muted small">NOUVEAU MOT DE PASSE</label>
                    <div class="position-relative">
                        <input type="password" class="form-control form-control-lg rounded-4 border-light bg-light"
                            id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <button type="button"
                            class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-muted"
                            onclick="togglePassword('newPassword')" style="text-decoration: none;">
                            <span id="eyeIcon1">üëÅÔ∏è</span>
                        </button>
                    </div>

                    <!-- Indicateur de force du mot de passe -->
                    <div class="mt-2">
                        <div class="progress" style="height: 6px;">
                            <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%">
                            </div>
                        </div>
                        <small id="passwordStrengthText" class="text-muted"></small>
                    </div>

                    <div class="form-text small mt-2">
                        <strong>Crit√®res :</strong>
                        <ul class="mb-0 mt-1" style="font-size: 0.85rem;">
                            <li id="criteria-length" class="text-muted">Au moins 8 caract√®res</li>
                            <li id="criteria-uppercase" class="text-muted">Une lettre majuscule</li>
                            <li id="criteria-lowercase" class="text-muted">Une lettre minuscule</li>
                            <li id="criteria-number" class="text-muted">Un chiffre</li>
                            <li id="criteria-special" class="text-muted">Un caract√®re sp√©cial (!@#$%^&*)</li>
                        </ul>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-muted small">CONFIRMER LE MOT DE PASSE</label>
                    <div class="position-relative">
                        <input type="password" class="form-control form-control-lg rounded-4 border-light bg-light"
                            id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <button type="button"
                            class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-muted"
                            onclick="togglePassword('confirmPassword')" style="text-decoration: none;">
                            <span id="eyeIcon2">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div id="passwordMatchMessage" class="form-text small"></div>
                </div>

                <div id="errorMessage" class="alert alert-danger d-none mb-3"></div>
                <div id="successMessage" class="alert alert-success d-none mb-3"></div>

                <div class="d-grid gap-3">
                    <button type="submit" class="btn btn-citizen py-3 fs-5" id="confirmBtn" disabled>
                        R√âINITIALISER LE MOT DE PASSE
                    </button>
                    <a href="{% url 'web_login' %}" class="btn btn-outline-secondary py-2 rounded-3">
                        Retour √† la connexion
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let passwordValid = false;
    let passwordsMatch = false;

    // R√©cup√©rer le token depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
        document.getElementById('errorMessage').textContent = 'Lien invalide. Veuillez demander un nouveau lien de r√©initialisation.';
        document.getElementById('errorMessage').classList.remove('d-none');
        document.getElementById('confirmResetForm').style.display = 'none';
    }

    function togglePassword(fieldId) {
        const passwordInput = document.getElementById(fieldId);
        const eyeIcon = document.getElementById(fieldId === 'newPassword' ? 'eyeIcon1' : 'eyeIcon2');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            eyeIcon.textContent = 'üëÅÔ∏è';
        }
    }

    function checkPasswordStrength(password) {
        const criteria = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Mettre √† jour les crit√®res visuels
        document.getElementById('criteria-length').className = criteria.length ? 'text-success' : 'text-muted';
        document.getElementById('criteria-uppercase').className = criteria.uppercase ? 'text-success' : 'text-muted';
        document.getElementById('criteria-lowercase').className = criteria.lowercase ? 'text-success' : 'text-muted';
        document.getElementById('criteria-number').className = criteria.number ? 'text-success' : 'text-muted';
        document.getElementById('criteria-special').className = criteria.special ? 'text-success' : 'text-muted';

        // Calculer le score
        const score = Object.values(criteria).filter(Boolean).length;
        const strengthBar = document.getElementById('passwordStrengthBar');
        const strengthText = document.getElementById('passwordStrengthText');

        let strength = '';
        let color = '';
        let width = 0;

        if (score === 0) {
            strength = '';
            color = '';
            width = 0;
        } else if (score <= 2) {
            strength = 'Faible';
            color = 'bg-danger';
            width = 33;
        } else if (score === 3) {
            strength = 'Moyen';
            color = 'bg-warning';
            width = 66;
        } else if (score === 4) {
            strength = 'Bon';
            color = 'bg-info';
            width = 85;
        } else {
            strength = 'Excellent';
            color = 'bg-success';
            width = 100;
        }

        strengthBar.className = `progress-bar ${color}`;
        strengthBar.style.width = `${width}%`;
        strengthText.textContent = strength ? `Force : ${strength}` : '';

        passwordValid = score >= 5;
        updateSubmitButton();
    }

    function checkPasswordMatch() {
        const password = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchMessage = document.getElementById('passwordMatchMessage');

        if (confirmPassword === '') {
            matchMessage.textContent = '';
            passwordsMatch = false;
        } else if (password === confirmPassword) {
            matchMessage.textContent = '‚úì Les mots de passe correspondent';
            matchMessage.className = 'form-text small text-success';
            passwordsMatch = true;
        } else {
            matchMessage.textContent = '‚úó Les mots de passe ne correspondent pas';
            matchMessage.className = 'form-text small text-danger';
            passwordsMatch = false;
        }
        updateSubmitButton();
    }

    function updateSubmitButton() {
        const confirmBtn = document.getElementById('confirmBtn');
        confirmBtn.disabled = !(passwordValid && passwordsMatch);
    }

    // Event listeners
    document.getElementById('newPassword').addEventListener('input', (e) => {
        checkPasswordStrength(e.target.value);
        checkPasswordMatch();
    });

    document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

    document.getElementById('confirmResetForm').onsubmit = async (e) => {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        const confirmBtn = document.getElementById('confirmBtn');

        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>R√©initialisation...';

        try {
            const response = await fetch('/api/password-reset/confirm/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: token,
                    new_password: newPassword
                })
            });

            const data = await response.json();

            if (response.ok) {
                successDiv.innerHTML = `
                    <strong>‚úì Mot de passe r√©initialis√© avec succ√®s !</strong><br>
                    <small>Vous allez √™tre redirig√© vers la page de connexion...</small>
                `;
                successDiv.classList.remove('d-none');

                setTimeout(() => {
                    window.location.href = '/login/';
                }, 2000);
            } else {
                errorDiv.textContent = data.error || 'Erreur lors de la r√©initialisation';
                errorDiv.classList.remove('d-none');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'R√âINITIALISER LE MOT DE PASSE';
            }
        } catch (error) {
            errorDiv.textContent = 'Erreur de connexion. Veuillez r√©essayer.';
            errorDiv.classList.remove('d-none');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'R√âINITIALISER LE MOT DE PASSE';
        }
    };
</script>
{% endblock %}